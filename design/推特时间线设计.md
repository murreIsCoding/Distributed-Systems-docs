# 设计推特的时间线和搜索功能
## 步骤1 ：列出用例和约束条件

> 收集需求和限定问题的范围
> 提出问题来清晰定义用例和约束条件
> 讨论假设条件

因为没有面试官来定义问题，我们将定义一些用例和约束。

### 用例

#### 我们将把这个问题的范围缩小到只处理以下用例

* 用户发布一条tweet(发推)
    * 服务会把这些推文推送给关注的人，并推送通知和emails。
*  用户可以查看用户的时间线(用户的活动记录)
*  用户可以查看主页的时间先(用户关注的其他人的活动记录)
*  用户可以搜索关键字
*  服务具有高可用性

#### 不在范围内的

*  服务推送到Twitter Firehose等流平台
*  服务根据用户的隐私设定来挑选推文
    * 如果用户没有关注某人，那么某人的回复不可见
    * 尊重“隐身转发”设定 （??什么东西）
*  数据分析

### 约束条件和假设

#### 状态假设
整体
* 流量并非均匀分布
* 发布一条推文必须很快
    * 将你的推文散布给每个粉丝必须很快，除非你有百万粉丝。
* 拥有1亿活动用户
* 一天产生5亿条推文，一个月产生150亿
    * 每条推文平均产生10次推送
    * 一天50亿次推送
    * 一个月产生1500亿推送
* 一个月2500亿次读取请求
* 一个月100亿次搜索

时间线
* 查看时间线必须非常快
* 推特的读取比写入繁重
    * 将推文的读取优化到最快
* 收取推文是写频繁的

搜索

* 搜索必须快
* 搜索是读取频繁的

#### 计算用量
* 每条推特的大小:
    * `tweet_id` - 8 bytes
    * `user_id` - 32 bytes
    * `text` - 140 bytes
    * `media` - 10 KB average
    * 一共: ~10 KB
* 每个月产生150TB新的推特数据
    * 10KB亿条推特 * 5亿推特每天 * 一个月30天
    * 3年产生5.4PB推特数据
* 每秒10万读取请求
    * 一个月2500亿读取请求*(400请求每秒/1个月1亿请求)
* 每秒6,000条推文
    * 每月150亿条推文* （每秒400条请求/每月10亿条请求）
* 每秒通过扇出传递6万条推文
    * 每月通过扇出传递1500亿条推文*（每秒400条请求/ 1每月十亿个请求）
* 每秒4,000个搜索请求

## 步骤2 :创建顶层设计
> 从顶层列出所有重要的组件

![Imgur](http://i.imgur.com/48tEA2j.png)

## 步骤3：设计核心组件
> 深入核心组件的细节

#### 用例:用户发一条推特
我们可以在关系数据库中保存用户自己的tweets，然后用它来填充用户个人的时间线。
比较棘手的是发表tweet以及构建主页时间线中(展示用户关注的人的活动)。将推特fanout给所有粉丝(每秒钟fanout6万条推特)将会使传统关系型数据库超载。我们希望选择一种高速写入的数据库，比如NoSQL数据库或者内存型缓存。从内存读取1MB需要花费250微秒，SSD需要4倍，普通硬盘花费80倍。

我们可以将图片等媒体资料存储到对象存储服务中。
* 客户端发送一条推特到网络服务(反向代理)
* 网络服务转发请求到 写API服务
* 写API服务将这条推特加入用户的时间线，保存在SQL数据库
* 写API连接Fanout服务，它将执行以下操作:
    * 查询用户图服务（运行在内存），寻找该用户的所有粉丝
    * 将这条推特存储到用户的主页时间轴中，保存在内存缓存中。
        * O（n）操作:1000个粉丝 = 1000个查找和插入
    * 将这条微博存到搜索索引服务，为了能够快速搜索到
    * 存储媒体文件到对象存储服务
    * 使用通知服务来推送通知给粉丝：
        * 使用一个队列(没在图上)来异步地发送通知

可以跟面试官确认你需要写多少的代码出来展示

如果你的内存缓存使用的是Redis,可以使用Redis list 构建下面这种数据结构:
```
           tweet n+2                   tweet n+1                   tweet n
| 8 bytes   8 bytes  1 byte | 8 bytes   8 bytes  1 byte | 8 bytes   8 bytes  1 byte |
| tweet_id  user_id  meta   | tweet_id  user_id  meta   | tweet_id  user_id  meta   |
```
新的推特会被放到内存缓存中，填充用户的主页时间轴（用户关注的人的活动）。

我们可以使用这样的公开REST API:
```
$ curl -X POST --data '{ "user_id": "123", "auth_token": "ABC123", \
    "status": "hello world!", "media_ids": "ABC987" }' \
    https://twitter.com/api/v1/tweet
```

响应:

```
{
    "created_at": "Wed Sep 05 00:37:15 +0000 2012",
    "status": "hello world!",
    "tweet_id": "987",
    "user_id": "123",
    ...
}
```








